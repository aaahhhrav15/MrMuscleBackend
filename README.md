# MuscleCRM Backend — Auth, Profile & Nutrition Plans

A minimal, production-sane Node/Express + MongoDB backend that already handles **login + profile** and now adds **Nutrition Plan** APIs (latest plan for the logged-in user, plus listing all plans). It’s JWT-secured and usable immediately from the **terminal** (via `curl`) before any frontend work.

---

## Table of Contents
- [Features](#features)
- [Tech Stack](#tech-stack)
- [Project Structure](#project-structure)
- [Prerequisites](#prerequisites)
- [Setup](#setup)
- [Environment Variables](#environment-variables)
- [Running Locally](#running-locally)
- [Seed Nutrition Data](#seed-nutrition-data)
- [Authentication](#authentication)
- [API Reference](#api-reference)
  - [Health](#health)
  - [Auth (existing)](#auth-existing)
  - [Users (existing)](#users-existing)
  - [Nutrition](#nutrition)
- [cURL Examples](#curl-examples)
- [Data Model](#data-model)
- [Troubleshooting](#troubleshooting)
- [Security Notes](#security-notes)
- [License](#license)

---

## Features
- ✅ JWT-secured routes using your existing auth middleware
- ✅ Nutrition Plans:
  - `GET /nutrition/plan` — returns the **latest plan** for logged-in user
  - `GET /nutrition/plans` — returns **all plans** for logged-in user (for history/debug)
- ✅ JSON seed script that imports nutrition plan data from Mongo export
- ✅ Can be tested fully from the terminal with `curl` or Node CLI
- ✅ Ready to plug into Flutter frontend later

---

## Tech Stack
- **Node.js** + **Express**
- **MongoDB** + **Mongoose**
- **JWT** for authentication
- **dotenv** for config
- **morgan** for logging

---

## Project Structure
```
gym-api/
├─ server.js                 # App entrypoint
├─ .env.example              # Environment variable template
├─ src/
│  ├─ routes/
│  │  ├─ auth.js             # Existing auth/login
│  │  ├─ users.js            # Existing user/profile
│  │  └─ nutrition.js        # NEW nutrition plan routes
│  ├─ models/
│  │  └─ NutritionPlan.js    # NEW mongoose schema
│  └─ middleware/
│     └─ auth.js             # JWT verification
└─ scripts/
   └─ seedNutrition.js        # Import JSON nutrition plans
```

---

## Prerequisites
- Node.js v18+ recommended
- MongoDB running locally or an Atlas cluster
- npm or yarn

---

## Setup
```bash
# Install dependencies
npm install

# Copy env template
cp .env.example .env
```

---

## Environment Variables
| Key          | Description                                | Example                             |
|--------------|--------------------------------------------|-------------------------------------|
| `PORT`       | Port number the API runs on                | 4000                                |
| `MONGO_URI`  | MongoDB connection string                  | mongodb://127.0.0.1:27017/musclecrm |
| `JWT_SECRET` | Secret for signing/verifying JWTs          | supersecret                         |
| `NODE_ENV`   | Environment mode                           | development                         |

---

## Running Locally
```bash
npm run dev
```

Server will be available at `http://localhost:4000`.

Check health:
```bash
curl http://localhost:4000/health
```

---

## Seed Nutrition Data
Place your Mongo export JSON (e.g. `musclecrm.nutritionplans.json`) in project root.

Run seeder:
```bash
npm run seed:nutrition
```

This imports the documents into the `nutritionplans` collection.

---

## Authentication
All secure routes expect:
```
Authorization: Bearer <JWT_TOKEN>
```

Tokens are generated by your existing login/OTP flow.

---

## API Reference

### Health
**GET /health**
- Returns `{ ok: true }`

---

### Auth (existing)
- **POST /auth/login-phone**
- **POST /auth/verify-otp**

(See your existing docs)

---

### Users (existing)
- **GET /users/me**

---

### Nutrition

#### GET /nutrition/plan
Returns the **latest plan** for the logged-in user.

**Response:**
```json
{
  "_id": "66b95f...",
  "plan_name": "Fat Loss Plan",
  "targets": { "calories": 2200, "protein": 150, "carbs": 200, "fat": 70 },
  "totals": { "calories": 2150, "protein": 148, "carbs": 198, "fat": 68 },
  "created_date": "2025-08-01T00:00:00Z",
  "meals": [
    {
      "meal_type": "Breakfast",
      "time": "8:00 AM",
      "calories": 400,
      "items": [
        {
          "food_name": "Oats",
          "quantity": "50g",
          "calories": 200,
          "protein": 8,
          "carbs": 36,
          "fat": 4
        }
      ]
    }
  ]
}
```

#### GET /nutrition/plans
Returns all plans for the logged-in user (newest first).

---

## cURL Examples

```bash
# Latest plan
curl -s http://localhost:4000/nutrition/plan   -H "Authorization: Bearer $TOKEN" | jq .

# All plans
curl -s http://localhost:4000/nutrition/plans   -H "Authorization: Bearer $TOKEN" | jq .
```

---

## Data Model

### NutritionPlan
```js
{
  user_id: ObjectId,
  plan_name: String,
  total_calories: Number,
  protein_target: Number,
  carbs_target: Number,
  fat_target: Number,
  created_date: Date,
  meals: [
    {
      meal_type: String,
      time: String,
      calories: Number,
      items: [
        {
          food_name: String,
          quantity: String,
          calories: Number,
          protein: Number,
          carbs: Number,
          fat: Number
        }
      ]
    }
  ],
  gymId: ObjectId
}
```

---

## Troubleshooting
- **Token invalid** → Ensure you’re passing a valid JWT from login flow.
- **No nutrition plan found** → Seed sample data or create a plan for that user.
- **Mongo connection error** → Check `MONGO_URI` in `.env`.

---

## Security Notes
- Don’t expose the `/scripts/seedNutrition.js` in production.
- Don’t allow clients to send `user_id` in body — always take from JWT.
- Consider tenant enforcement with `gymId`.

---

## License
MIT
